name: 'Static analysis'

on: [ push ]

jobs:
  lint:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ ubuntu-latest ]
        python-version: [ '3.8' ]

    steps:
      - uses: actions/checkout@v3

      - name: "Set up Python ${{ matrix.python-version }}"
        uses: actions/setup-python@v3
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: 'Install dependencies'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 'Install in develop mode'
        run: |
          pip install --editable .

      - name: 'Find Python files in fcg/, scripts/ and tests/'
        id: find_python_files
        run: |
          echo "::set-output name=fcg::$(git ls-files 'fcg/**.py' | xargs echo)"
          echo "::set-output name=scripts::$(git ls-files 'scripts/**.py' | xargs echo)"
          echo "::set-output name=tests::$(git ls-files 'tests/**.py' | xargs echo)"

      - name: 'Linting with pylint'
        run: |
          pylint --jobs 0 ${{ steps.find_python_files.outputs.fcg }} ${{ steps.find_python_files.outputs.scripts }}
          pylint --jobs 0 --disable=missing-docstring,protected-access ${{ steps.find_python_files.outputs.tests }}
          pylint --disable=missing-docstring setup.py

      - name: 'Linting with flake8'
        run: |
          flake8 ${{ steps.find_python_files.outputs.fcg }} ${{ steps.find_python_files.outputs.scripts }} ${{ steps.find_python_files.outputs.tests }}

      - name: 'Check static types with mypy'
        run: |
          mypy ${{ steps.find_python_files.outputs.fcg }} ${{ steps.find_python_files.outputs.scripts }} ${{ steps.find_python_files.outputs.tests }}

      - name: 'Test with pytest'
        run: |
          pytest ${{ steps.find_python_files.outputs.tests }}